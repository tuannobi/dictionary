<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Collection</title>
    <link rel="stylesheet" th:href="@{/resources/static/client/css/bootstrap.min.css}">
</head>
<body>
    <div class="container-fluid">
        <div>
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/admin/vocabularies}">Vocabulary</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/admin/collections}">Collection</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/web/admin/vocabularies}">Vocabulary</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Dropdown
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="#">Action</a>
                                <a class="dropdown-item" href="#">Another action</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#">Something else here</a>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                        </li>
                    </ul>
                    <form class="form-inline my-2 my-lg-0">
                        <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                    </form>
                </div>
            </nav>
        </div>
        <div class="row">
            <button data-action="Add" data-toggle="modal" data-target="#formModal" type="button" class="btn btn-success btn btn-success ml-auto mr-4 mb-4 mt-4">Add Collection</button>
        </div>
        <div class="row mr-4 ml-4">
            <table id="collectionTable" class="table table-dark">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Name</th>
                    <th scope="col">Create Date</th>
                    <th scope="col">Update Date</th>
                    <th scope="col">Available</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  
                </tbody>
              </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="formModalLabel">Add Collection Form</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="form">
                        <div class="form-group">
                            <label for="name">Name: </label>
                            <input name="name" type="text" class="form-control" required>
                        </div>
                        <!-- <span class="alert alert-danger" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></span> -->

                        <div class="form-group">
                            <label for="description">Description: </label>
                            <textarea id="description" class="form-control"></textarea>
                        </div>
                        <!-- <span class="alert alert-danger" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></span> -->

                        <div class="form-group">
                            <label for="password">Option: </label>
                            <select id="access" class="form-control">
                                <option value="true">Available</option>
                                <option value="false">Not availble</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <input type="file" class="form-control-file" id="file">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary actionButton"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Do you want to delete this collection?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button id="deleteButton" type="button" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <script th:src="@{/resources/static/client/js/jquery-3.5.1.min.js}"></script>
    <script th:src="@{/resources/static/client/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/resources/static/client/js/bootstrap.min.js}"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script th:src="@{https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js}"></script>
    <script th:src="@{https://www.gstatic.com/firebasejs/7.20.0/firebase-storage.js}"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->
    <script th:src="@{https://www.gstatic.com/firebasejs/7.20.0/firebase-analytics.js}"></script>

    <script>
    	$(document).ready(function(){
            let firebaseConfig = {
                apiKey: "AIzaSyBfpYp6IRWZx6s8-PAtRB30wXJK6cWWTrI",
                authDomain: "final-dictionary-project.firebaseapp.com",
                databaseURL: "https://final-dictionary-project.firebaseio.com",
                projectId: "final-dictionary-project",
                storageBucket: "final-dictionary-project.appspot.com",
                messagingSenderId: "963389369020",
                appId: "1:963389369020:web:60f5375a1b6774eb117eb9",
                measurementId: "G-E6J9246Q79"
            };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            firebase.analytics();
            let storageRef = firebase.storage().ref();
            let metadata = {
                contentType: 'image/jpeg',
            };

    	    let current_id;
            $.ajax({
                url: "http://localhost:8090/tuno/rest/admin/collections",
                type: 'GET',
                error : function(err) {
                    console.log('Error!', err)
                },
                success: function(data) {
                    console.log('Success!')
                    let i = 0;
                    data.forEach(function (item){
                        i++
                        let isAccess = "❌";
                        if(item.access==1){
                            isAccess="✅"
                        }
                        $('#collectionTable > tbody').append('<tr id="'+item.id+'">\
                                                <th scope="row">'+i+'</th>\
                                                <td>'+item.name+'</td>\
                                                <td>'+item.createDate+'</td>\
                                                <td>'+item.updateTime+'</td>\
                                                <td>'+isAccess+'</td>\
                                                <td>\
                                                    <button type="button" title="Detail" class="btn btn-info">Detail</button>\
                                                    <button data-action="Update" data-toggle="modal" data-target="#formModal" type="button" title="Update" class="btn btn-warning">Update</button>\
                                                    <button data-toggle="modal" data-target="#deleteModal" type="button" title="Delete" class="btn btn-danger">Delete</button>\
                                                </td>\
                                            </tr>');
                    })
                }
            });

            $('#formModal').on('show.bs.modal', function (event) {
                let button = $(event.relatedTarget); // Button that triggered the modal
                let action = button.data('action'); // Extract info from data-* attributes
                // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                let modal = $(this)
                modal.find('.modal-title').text(action+' Collection Form')
                if(action=="Add"){
                    $('input[name="name"]').val('')
                    $('#description').val('')
                    $("#access [value='true']").prop('selected',true)
                    modal.find('.actionButton').attr('id','addButton')
                    modal.find('#addButton').text("Add")
                }else if(action=="Update"){
                    modal.find('.actionButton').attr('id','updateButton')
                    modal.find('#updateButton').text("Update")
                    let id=button.closest('tr').attr('id')
                    current_id=id;
                    $.ajax({
                        url: "http://localhost:8090/tuno/rest/admin/collections/"+id,
                        type: 'GET',
                        error : function(err) {
                            console.log('Error!', err)
                        },
                        success: function(data) {
                            console.log('Success!')
                            console.log("Start")
                            $('input[name="name"]').val(data.name)
                            $('#description').val(data.description)
                            $("#access [value="+data.access+"]").prop('selected',true)
                        }
                    });
                }
            });

            $('#deleteModal').on('show.bs.modal', function (event) {
                let button = $(event.relatedTarget) // Button that triggered the modal
                let recipient = button.data('whatever') // Extract info from data-* attributes
                // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
                // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
                let modal = $(this)
                let id=button.closest('tr').attr('id')
                current_id=id
                modal.find('.deleteButton').attr('id',id)
            })

            $(document).on('click', '#addButton', function(){
                let file=document.querySelector('#file').files[0]
                let pathFile='Collections/'+Date.now()+'_'+file.name;
                let uploadTask = storageRef.child(pathFile).put(file, metadata);
                // Listen for state changes, errors, and completion of the upload.
                uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
                    function(snapshot) {
                        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                        let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                        switch (snapshot.state) {
                            case firebase.storage.TaskState.PAUSED: // or 'paused'
                                console.log('Upload is paused');
                                break;
                            case firebase.storage.TaskState.RUNNING: // or 'running'
                                console.log('Upload is running');
                                break;
                        }
                    }, function(error) {

                        // A full list of error codes is available at
                        // https://firebase.google.com/docs/storage/web/handle-errors
                        switch (error.code) {
                            case 'storage/unauthorized':
                                // User doesn't have permission to access the object
                                break;

                            case 'storage/canceled':
                                // User canceled the upload
                                break;

                            case 'storage/unknown':
                                // Unknown error occurred, inspect error.serverResponse
                                break;
                        }
                    }, function() {
                        // Upload completed successfully, now we can get the download URL
                        uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                            console.log('File available at', downloadURL);
                            $.ajax({
                                url: "http://localhost:8090/tuno/rest/admin/collections",
                                type: 'POST',
                                // headers: {
                                //     'Accept': 'application/json',
                                //     'Content-Type': 'application/json'
                                // },
                                data: JSON.stringify({
                                    'id':'',
                                    'name':$('input[name="name"]').val(),
                                    'description':$('#description').val(),
                                    'imageNames':pathFile,
                                    'createDate':'',
                                    'updateTime':'',
                                    'access':$('#access').find(':selected').val()
                                }),
                                contentType: 'application/json',
                                error : function(err) {
                                    console.log('Error!', err)
                                },
                                success: function(data) {
                                    console.log('Success!')
                                    location.reload()
                                }
                            });
                        });
                    });


            });

            $(document).on('click', '#updateButton', function(){
                $.ajax({
                    url: "http://localhost:8090/tuno/rest/admin/collections",
                    type: 'PUT',
                    // headers: {
                    //     'Accept': 'application/json',
                    //     'Content-Type': 'application/json'
                    // },
                    data: JSON.stringify({
                        'id':current_id,
                        'name':$('input[name="name"]').val(),
                        'description':$('#description').val(),
                        'imageNames':'',
                        'createDate':'',
                        'updateTime':'',
                        'access':$('#access').find(':selected').val()
                    }),
                    contentType: 'application/json',
                    error : function(err) {
                        console.log('Error!', err)
                    },
                    success: function(data) {
                        console.log('Success!')
                        location.reload()
                    }
                });
            });

            $(document).on('click', '#deleteButton', function() {
                // Create a reference to the file to delete
                let desertRef = storageRef.child('images/desert.jpg');
                // Delete the file
                desertRef.delete().then(function() {
                    // File deleted successfully
                }).catch(function(error) {
                    alert(error)
                });
                $.ajax({
                    url: "http://localhost:8090/tuno/rest/admin/collections/"+current_id,
                    type: 'DELETE',
                    error : function(err) {
                        console.log('Error!', err)
                    },
                    success: function(data) {
                        console.log('Success!')
                        location.reload()
                    }
                });
            });


        });
    </script>
</body>
</html>